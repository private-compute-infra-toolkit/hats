# Copyright 2024 Google LLC.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#      https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

build --config=clang
build --config=cpp_toolchain
# Define a macro used in psp-sev.h
build --per_file_copt=psp-sev.,.kernel_api.,.launcher.@-D__packed=__attribute__((__packed__))
# Use nightly rustc by default
build --@rules_rust//rust/toolchain/channel=nightly
build --config=rustfmt
build --config=clippy
# Hide warnings for external libraries
# external_include_paths actually stops warnings (helps with stricter build flags), but seems to only be for .h files, not most .cc files.
build --output_filter='^//((?!(external):).)*$'

# Prevent Bazel from detecting the system's C++ toolchain.
build:cpp_toolchain --action_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1
build:cpp_toolchain --incompatible_strict_action_env=true
# Enable the CC toolchain resolution based on platforms.
build:cpp_toolchain --incompatible_enable_cc_toolchain_resolution

# Output more information on failure
build --verbose_failures
test --test_output=errors

build:clang --cxxopt='-std=c++20'
build:clang --host_cxxopt='-std=c++20'
# Warn if not every switch case is covered
build:clang --cxxopt='-Wswitch'
build:clang --cxxopt='-Werror=switch'

build:rustfmt --aspects=@rules_rust//rust:defs.bzl%rustfmt_aspect
build:rustfmt --output_groups=+rustfmt_checks

build:clippy --aspects=@rules_rust//rust:defs.bzl%rust_clippy_aspect
build:clippy --output_groups=+clippy_checks
# depend_on_what_you_use build check
build:dwyu --aspects=//dwyu:dwyu.bzl%hats_dwyu_aspect
build:dwyu --output_groups=dwyu
build:dwyu --verbose_failures=false

# this rule is to enable the rust analyzer in vs code
build --@rules_rust//:rustc_output_diagnostics=true --output_groups=+rust_lib_rustc_output,+rust_metadata_rustc_output
